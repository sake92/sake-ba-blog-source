<!DOCTYPE html><html lang="en"><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta name="viewport" content="width=device-width, initial-scale=1" /><meta name="generator" content="hepek" /><meta name="theme-color" content="#000" /><meta name="mobile-web-app-capable" content="yes" /><meta name="description" content="API-First Scala" /><meta property="og:title" content="blog.sake.ba" /><meta name="twitter:card" content="summary_large_image" /><title>API-First Scala - blog.sake.ba</title><link rel="shortcut icon" href="../../../images/favicon.svg" type="image/svg+xml" /><link rel="stylesheet" href="../../../styles/vendor/pico.conditional.min.css" /><link rel="stylesheet" href="../../../styles/main.css" /><link rel="manifest" href="../../../manifest.json" /></head><body class="match-braces"><main class="pico container"><nav><ul><li><a href="../../index.html"><span><img src="/images/logo.png" alt="logo" style="height: 32px;" /></span><strong>blog.sake.ba</strong></a></li></ul><ul><li><a href="index.html" class="">Programming</a></li></ul></nav><div class="blog-post"><aside><nav><ul><li><a href="monads.html" class="secondary">Monadic stuff</a></li><li><a href="api-first-scala.html" class="">API-First Scala</a></li></ul></nav></aside><article><section><h2 id="intro">Intro</h2><p>There are many ways to build APIs:</p>
<ul>
<li>YOLO approach</li>
<li>code-first approach</li>
<li>API-first approach</li>
</ul>
<h3>YOLO approach</h3>
<p>In the &quot;YOLO mode&quot; you don't care much about the users of your API.<br />
Maybe you have a few examples or docs you made, but nothing too serious.</p>
<h3>Code-first approach</h3>
<p>In the &quot;code-first&quot; approach you start with the coding right away.
Schedules are tight, deadlines are near, pressure is real.</p>
<p>The specification (if any) is mostly an afterthought.
Consider Spring annotations, you can always sprinkle some <code>@ApiParam</code> here and there in your controllers.</p>
<p>There are also approaches like <a href="https://tapir.softwaremill.com/en/latest/">Tapir</a>,
where you use a Scala DSL to define your API.
Then you implement the server logic, and generate the spec from that Scala code.
Potentially the client(s) too.</p>
<p>This approach is popular, since you start with coding right away.
But it has some downsides:</p>
<ul>
<li>you kinda play russian roulette with the spec, since it is generated from the code, so you can't really call it stable</li>
<li>it is more code to maintain, increasing your cognitive load and compile times</li>
<li>bundle size is increased, since you have to include the dependencies</li>
<li>sometimes you have to fight the DSL to get what you want (e.g polymorphic payloads and such)</li>
<li>you are limited by what DSL provides, if you need some framework-specific feature, it's challenging to get to it (or impossible)</li>
</ul>
<h3>API-first approach</h3>
<p>In the &quot;API-first&quot; approach you start with the API specification.
You define the API usually with OpenAPI (Swagger) in a YAML or JSON file.
Then you generate the server from that spec (and client code if need be).</p>
<p>This approach has some advantages:</p>
<ul>
<li>you are in full control of the spec, it is <em>the source of truth</em></li>
<li>spec is <em>stable</em> and <em>versioned</em></li>
<li>less code to maintain, there is no DSLs or annotations that obfuscate your code</li>
<li>you can leverage your framework's features to the max</li>
</ul>
<p>An example in Scala is the <a href="https://guardrail.dev">Guardrail</a> tool.
It generates some server boilerplate code to the <code>target/.../src_managed/main</code> folder (you don't commit this to git).
Then you implement the server logic by <em>overriding those abstract definitions</em>, fill in the blanks essentially.
Note that when you change the <code>openapi.yaml</code>, the <code>src_managed</code> code is overwritten.
Guardrail is a nice approach, sadly it doesn't support Scala 3 yet.</p>
<p>A new kid on the block is the <a href="https://github.com/sake92/openapi4s">OpenApi4s</a> tool that I made.
It takes a bit different approach, it doesn't hide the server code from you, it generates it <em>directly in your <code>src</code> folder</em>.
Exactly like you would have written it by hand.<br />
So how does it handle changes in the spec??? Overwrite the code every time? No, that would be silly, so let's see...</p>
</section><section><h2 id="open-api4s">OpenApi4s</h2><p>TLDR: <a href="https://github.com/sake92/openapi4s">OpenApi4s</a> refactors your code automatically, by using <a href="https://github.com/sake92/regenesca">regenesca</a> diff+merge library.</p>
<p>Generating the models and controllers is the easy part:</p>
<ul>
<li>parse the OpenAPI spec</li>
<li>generate models</li>
<li>generate controllers</li>
</ul>
<p>and that's it.</p>
<hr />
<p>The hard part is <em>how to handle changes in the spec</em>.</p>
<p>Consider the classical <a href="https://petstore3.swagger.io">PetStore spec</a>.
OpenApi4s will generate something like this for the <code>User</code> model:</p>
<pre class="shiki material-theme-ocean" style="background-color:#0F111A;color:#babed8" tabindex="0"><code><span class="line"><span style="color:#89DDFF">case</span><span style="color:#89DDFF"> class</span><span style="color:#FFCB6B"> User</span><span style="color:#BABED8">(</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">  id</span><span style="color:#BABED8">: </span><span style="color:#FFCB6B">Option</span><span style="color:#BABED8">[</span><span style="color:#FFCB6B">Long</span><span style="color:#BABED8">],</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">  username</span><span style="color:#BABED8">: </span><span style="color:#FFCB6B">Option</span><span style="color:#BABED8">[</span><span style="color:#FFCB6B">String</span><span style="color:#BABED8">],</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">  firstName</span><span style="color:#BABED8">: </span><span style="color:#FFCB6B">Option</span><span style="color:#BABED8">[</span><span style="color:#FFCB6B">String</span><span style="color:#BABED8">],</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">  lastName</span><span style="color:#BABED8">: </span><span style="color:#FFCB6B">Option</span><span style="color:#BABED8">[</span><span style="color:#FFCB6B">String</span><span style="color:#BABED8">],</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">  email</span><span style="color:#BABED8">: </span><span style="color:#FFCB6B">Option</span><span style="color:#BABED8">[</span><span style="color:#FFCB6B">String</span><span style="color:#BABED8">],</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">  password</span><span style="color:#BABED8">: </span><span style="color:#FFCB6B">Option</span><span style="color:#BABED8">[</span><span style="color:#FFCB6B">String</span><span style="color:#BABED8">],</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">  phone</span><span style="color:#BABED8">: </span><span style="color:#FFCB6B">Option</span><span style="color:#BABED8">[</span><span style="color:#FFCB6B">String</span><span style="color:#BABED8">],</span></span>
<span class="line"><span style="color:#BABED8;font-style:italic">  userStatus</span><span style="color:#BABED8">: </span><span style="color:#FFCB6B">Option</span><span style="color:#BABED8">[</span><span style="color:#FFCB6B">Int</span><span style="color:#BABED8">]</span></span>
<span class="line"><span style="color:#BABED8">) </span><span style="color:#89DDFF">derives</span><span style="color:#FFCB6B"> JsonRW</span></span></code></pre>
<h3>Adding a new property</h3>
<p>When you add a new <code>age</code> field of type <code>integer</code> to the <code>User</code> model.
OpenApi4s will compare the newly generated <code>case class User</code> (in-memory), with the existing <code>case class User</code> in your source code.
Then it will figure out that <code>age: Int</code> parameter is missing, and it will add it.</p>
<pre class="shiki material-theme-ocean" style="background-color:#0F111A;color:#babed8" tabindex="0"><code><span class="line"><span style="color:#89DDFF">---</span><span style="color:#BABED8"> a/api/src/com/example/petstore/api/models/User.scala</span></span>
<span class="line"><span style="color:#89DDFF">+++</span><span style="color:#BABED8"> b/api/src/com/example/petstore/api/models/User.scala</span></span>
<span class="line"><span style="color:#89DDFF">@@</span><span style="color:#BABED8"> -14,5 +14,5 </span><span style="color:#89DDFF">@@</span><span style="color:#BABED8"> case class User(</span></span>
<span class="line"><span style="color:#BABED8">   email: Option[String],</span></span>
<span class="line"><span style="color:#BABED8">   password: Option[String],</span></span>
<span class="line"><span style="color:#BABED8">   phone: Option[String],</span></span>
<span class="line"><span style="color:#89DDFF">-</span><span style="color:#F07178">  userStatus: Option[Int]</span></span>
<span class="line"><span style="color:#89DDFF">+</span><span style="color:#C3E88D">  userStatus: Option[Int], age: Long</span></span>
<span class="line"><span style="color:#BABED8"> ) derives JsonRW</span></span></code></pre>
<h3>Changing a property</h3>
<p>Let's say you change the <code>userStatus</code>'s format from <code>int32</code> to <code>int64</code>.
OpenApi4s will figure out that <code>userStatus: Option[Int]</code> needs to be changed to <code>userStatus: Option[Long]</code>.</p>
<pre class="shiki material-theme-ocean" style="background-color:#0F111A;color:#babed8" tabindex="0"><code><span class="line"><span style="color:#89DDFF">---</span><span style="color:#BABED8"> a/api/src/com/example/petstore/api/models/User.scala</span></span>
<span class="line"><span style="color:#89DDFF">+++</span><span style="color:#BABED8"> b/api/src/com/example/petstore/api/models/User.scala</span></span>
<span class="line"><span style="color:#89DDFF">@@</span><span style="color:#BABED8"> -14,5 +14,6 </span><span style="color:#89DDFF">@@</span><span style="color:#BABED8"> case class User(</span></span>
<span class="line"><span style="color:#BABED8">   email: Option[String],</span></span>
<span class="line"><span style="color:#BABED8">   password: Option[String],</span></span>
<span class="line"><span style="color:#BABED8">   phone: Option[String],</span></span>
<span class="line"><span style="color:#89DDFF">-</span><span style="color:#F07178">  userStatus: Option[Int]</span></span>
<span class="line"><span style="color:#89DDFF">+</span><span style="color:#C3E88D">  userStatus: Option[Long]</span></span></code></pre>
<h3>Adding a new endpoint</h3>
<p>Adding a new endpoint to existing controller is easy too.
It will just add another <code>case</code> to your existing routes.
For example in sharaf framework it will add something like this:</p>
<pre class="shiki material-theme-ocean" style="background-color:#0F111A;color:#babed8" tabindex="0"><code><span class="line"><span style="color:#89DDFF;font-style:italic">case</span><span style="color:#FFCB6B"> GET</span><span style="color:#89DDFF"> -></span><span style="color:#FFCB6B"> Path</span><span style="color:#BABED8">(</span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">user</span><span style="color:#89DDFF">"</span><span style="color:#BABED8">, </span><span style="color:#89DDFF">"</span><span style="color:#C3E88D">new-endpoint</span><span style="color:#89DDFF">"</span><span style="color:#BABED8">) </span><span style="color:#89DDFF">=></span></span>
<span class="line"><span style="color:#FFCB6B">  Response</span><span style="color:#BABED8">.withStatus(</span><span style="color:#FFCB6B">StatusCodes</span><span style="color:#BABED8">.</span><span style="color:#FFCB6B">NOT_IMPLEMENTED</span><span style="color:#BABED8">)</span></span></code></pre>
<p>It will even generate a boilerplate implementation for you.
You can then fill in the blanks.</p>
<h3>Changing an endpoint</h3>
<p>Now this is a bit more tricky.
OpenApi4s must not touch your existing code, since you might have already implemented some logic.
So it will not touch your existing expressions, for example <code>Response.withStatus(..)</code> in the previous example.</p>
<p>But it will update the query parameters if needed.</p>
</section><section><h2 id="ci">CI</h2><h3>Preventing accidental overwrites</h3>
<p>You might be cautious about the changes that OpenApi4s makes.
Thinking, will it overwrite my code? How can I make sure it doesn't?
A simple check you can do in your CI pipeline is to:</p>
<ul>
<li>touch the <code>openapi.yaml</code> file, just so that <code>mill</code> detects a change and triggers openapi4s</li>
<li>compile the code, to regenerate the files</li>
<li>see if there are any changes in the git diff</li>
</ul>
<p>Example:</p>
<pre class="shiki material-theme-ocean" style="background-color:#0F111A;color:#babed8" tabindex="0"><code><span class="line"><span style="color:#82AAFF">echo</span><span style="color:#89DDFF"> "</span><span style="color:#89DDFF"> "</span><span style="color:#89DDFF"> >></span><span style="color:#C3E88D"> api/resources/openapi.yaml</span></span>
<span class="line"><span style="color:#FFCB6B">./mill</span><span style="color:#C3E88D"> api.compile</span></span>
<span class="line"><span style="color:#FFCB6B">truncate</span><span style="color:#C3E88D"> -s</span><span style="color:#C3E88D"> -1</span><span style="color:#C3E88D"> api/resources/openapi.yaml</span></span>
<span class="line"><span style="color:#FFCB6B">git</span><span style="color:#C3E88D"> diff</span><span style="color:#C3E88D"> --exit-code</span></span>
<span class="line"><span style="color:#89DDFF">[</span><span style="color:#BABED8"> $? </span><span style="color:#89DDFF">-eq</span><span style="color:#F78C6C"> 0</span><span style="color:#89DDFF"> ]</span><span style="color:#89DDFF">  ||</span><span style="color:#82AAFF"> exit</span><span style="color:#F78C6C"> 1</span></span></code></pre>
<h3>Preventing breaking changes</h3>
<p>Since the <code>openapi.yaml</code> is now in <code>git</code>, you can do some cool stuff with it.
One very useful check is preventing breaking changes.
You can do it with <a href="https://github.com/OpenAPITools/openapi-diff">openapi-diff</a> for example:</p>
<pre class="shiki material-theme-ocean" style="background-color:#0F111A;color:#babed8" tabindex="0"><code><span class="line"><span style="color:#FFCB6B">git</span><span style="color:#C3E88D"> show</span><span style="color:#C3E88D"> origin/main:api/resources/public/openapi.json</span><span style="color:#89DDFF"> ></span><span style="color:#C3E88D"> main_openapi.json</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B">cs</span><span style="color:#C3E88D"> launch</span><span style="color:#C3E88D"> org.openapitools.openapidiff:openapi-diff-cli:2.1.0-beta.12</span><span style="color:#C3E88D"> -M</span><span style="color:#C3E88D"> org.openapitools.openapidiff.cli.Main</span><span style="color:#C3E88D"> --</span><span style="color:#C3E88D"> --fail-on-incompatible</span><span style="color:#C3E88D"> main_openapi.json</span><span style="color:#C3E88D"> ./api/resources/public/openapi.json</span></span>
<span class="line"><span style="color:#89DDFF">[</span><span style="color:#BABED8"> $? </span><span style="color:#89DDFF">-eq</span><span style="color:#F78C6C"> 0</span><span style="color:#89DDFF"> ]</span><span style="color:#89DDFF">  ||</span><span style="color:#82AAFF"> exit</span><span style="color:#F78C6C"> 1</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B">rm</span><span style="color:#C3E88D"> main_openapi.json</span></span></code></pre>
<p>See the <a href="https://github.com/sake92/openapi4s-demo/blob/main/.github/workflows/ci.yml">CI script</a> in the openapi4s demo repo.</p>
<p>Here is an example of <a href="https://github.com/sake92/openapi4s-demo/pull/2">compatible change PR</a>.<br />
And an example of <a href="https://github.com/sake92/openapi4s-demo/pull/3">breaking change PR</a>, CI fails of course.</p>
</section><section><h2 id="conclusion">Conclusion</h2><p>Hope you find this post (and OpenApi4s tool) useful.<br />
You can find more tools to combine with api-first approach at <a href="https://openapi.tools/">https://openapi.tools/</a></p>
<p>Check out the video demo too:</p>
 <iframe width="100%" src="https://www.youtube.com/embed/kf0vGrlKNb8?si=l9_hclW2cr2Rc9Pd" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe> <h3>Additional resources</h3>
<ul>
<li><a href="https://swagger.io/resources/articles/adopting-an-api-first-approach/">Understanding the API-First Approach</a></li>
<li><a href="https://guardrail.dev">Guardrail</a></li>
<li><a href="https://tapir.softwaremill.com/en/latest/">Tapir</a></li>
<li><a href="https://www.baeldung.com/spring-rest-openapi-documentation">Documenting a Spring REST API Using OpenAPI 3.0</a></li>
</ul>
</section></article></div></main><script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.1.0/anchor.min.js"></script><script src="../../../scripts/main.js"></script></body></html>